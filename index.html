<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idea Spark</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
    <!-- USER ACTION: When wrapping for mobile, you'll integrate AdMob here -->
    <style>
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --text-main: white;
            --text-secondary: #e0e7ff;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --input-bg: rgba(255, 255, 255, 0.1);
            --tab-active-bg: rgba(255, 255, 255, 0.2);
            --button-primary-bg: white;
            --button-primary-text: #5b21b6;
            --button-secondary-bg: rgba(255, 255, 255, 0.2);
            --button-secondary-hover-bg: rgba(255, 255, 255, 0.3);
            --favorite-color: #facc15; /* yellow-400 */
            --font-main: 'Inter', sans-serif;
        }

        [data-theme="light"] {
            --bg-gradient-start: #f3f4f6;
            --bg-gradient-end: #d1d5db;
            --text-main: #1f2937;
            --text-secondary: #4b5563;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(209, 213, 219, 1);
            --input-bg: rgba(255, 255, 255, 1);
            --tab-active-bg: rgba(0, 0, 0, 0.1);
            --button-primary-bg: #4f46e5;
            --button-primary-text: white;
            --button-secondary-bg: rgba(0, 0, 0, 0.05);
            --button-secondary-hover-bg: rgba(0, 0, 0, 0.1);
            --favorite-color: #ca8a04; /* yellow-600 */
        }

        [data-theme="dark"] {
            --bg-gradient-start: #1f2937;
            --bg-gradient-end: #111827;
            --text-main: #f9fafb;
            --text-secondary: #9ca3af;
            --glass-bg: rgba(55, 65, 81, 0.5);
            --glass-border: rgba(75, 85, 99, 0.6);
            --input-bg: rgba(255, 255, 255, 0.1);
            --tab-active-bg: rgba(75, 85, 99, 1);
            --button-primary-bg: #374151;
            --button-primary-text: white;
            --button-secondary-bg: rgba(255, 255, 255, 0.1);
            --button-secondary-hover-bg: rgba(255, 255, 255, 0.2);
            --favorite-color: #facc15;
        }

        [data-theme="hacker"] {
            --bg-gradient-start: #000000;
            --bg-gradient-end: #0D0D0D;
            --text-main: #00FF00;
            --text-secondary: #00B300;
            --glass-bg: rgba(0, 255, 0, 0.05);
            --glass-border: rgba(0, 255, 0, 0.1);
            --input-bg: rgba(0, 255, 0, 0.1);
            --tab-active-bg: rgba(0, 255, 0, 0.2);
            --button-primary-bg: #00FF00;
            --button-primary-text: #000000;
            --button-secondary-bg: rgba(0, 255, 0, 0.1);
            --button-secondary-hover-bg: rgba(0, 255, 0, 0.2);
            --favorite-color: #00FF00;
            --font-main: 'Inconsolata', monospace;
        }

        body {
            font-family: var(--font-main);
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
            padding-bottom: 70px; /* Add padding for ad banner */
        }
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        /* Adjusted themed-input to ensure better contrast on dark themes */
        .themed-input {
            background-color: var(--input-bg);
            border-color: var(--glass-border);
            color: var(--text-main);
            /* Added specific styles for dropdown text visibility */
            -webkit-appearance: none; /* Remove default dropdown arrow for better styling */
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        .themed-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .tab.active, .secondary-btn.active { background-color: var(--tab-active-bg); }
        .chat-bubble { padding: 0.75rem 1rem; border-radius: 1rem; max-width: 80%; }
        .chat-bubble-user { background-color: rgba(255, 255, 255, 0.2); align-self: flex-end; border-bottom-right-radius: 0.25rem; }
        .chat-bubble-ai { background-color: rgba(0, 0, 0, 0.2); align-self: flex-start; border-bottom-left-radius: 0.25rem; }
        textarea { resize: none; overflow-y: hidden; }
        .folder-item.active { background-color: var(--tab-active-bg); }
        .secondary-btn {
            background-color: var(--button-secondary-bg);
            color: var(--text-main);
        }
        .secondary-btn:hover {
            background-color: var(--button-secondary-hover-bg);
        }
        /* Ad Banner Styling */
        #adBanner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-top: 1px solid var(--glass-border);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4">

    <!-- Header -->
    <header class="text-center mb-6 relative">
        <h1 class="text-4xl font-bold">Idea Spark âœ¨</h1>
        <p class="mt-2" style="color: var(--text-secondary);">Your personal AI brainstorming partner</p>
    </header>

    <!-- Main Content Area -->
    <div class="w-full max-w-4xl mx-auto flex-grow">

        <!-- Top Tab Menu -->
        <nav class="w-full max-w-lg mx-auto glass-card rounded-full p-2 mb-6">
            <div class="flex justify-around">
                <button id="generatorTab" class="tab active flex-1 text-center font-semibold py-2 px-4 rounded-full transition">Generator</button>
                <button id="savedTab" class="tab flex-1 text-center font-semibold py-2 px-4 rounded-full transition">Saved</button>
                <button id="themesTab" class="tab flex-1 text-center font-semibold py-2 px-4 rounded-full transition">Themes</button>
                <button id="storeTab" class="tab flex-1 text-center font-semibold py-2 px-4 rounded-full transition">Store</button>
            </div>
        </nav>

        <!-- Generator View -->
        <div id="generatorView" class="w-full max-w-md mx-auto">
            <div class="glass-card rounded-2xl shadow-2xl p-6 md:p-8">
                <main>
                    <div class="mb-4">
                        <label for="topic" class="block text-sm font-medium" style="color: var(--text-secondary);">What topic do you need ideas for?</label>
                        <input type="text" id="topic" class="w-full mt-1 border rounded-lg py-3 px-4 focus:outline-none themed-input" placeholder="e.g., 'podcast names'">
                    </div>

                    <button id="generateBtn" class="w-full font-bold py-3 px-4 rounded-lg transition-all shadow-lg transform hover:scale-105" style="background-color: var(--button-primary-bg); color: var(--button-primary-text);">
                        Generate Ideas
                    </button>

                    <div id="results-container" class="mt-6">
                        <h2 class="text-xl font-semibold mb-3">Your Ideas:</h2>
                        <div id="loader" class="hidden text-center">
                            <svg class="animate-spin h-8 w-8 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                        <div id="results" class="space-y-3"></div>
                         <p id="error-message" class="hidden text-red-400 text-center"></p>
                    </div>
                </main>
            </div>
        </div>
        <!-- Saved Ideas View -->
        <div id="savedView" class="hidden">
             <div class="glass-card rounded-2xl shadow-2xl p-4 md:p-8 flex flex-col md:flex-row gap-6">
                <!-- Left Panel: Folders -->
                <aside class="w-full md:w-1/3 md:border-r md:pr-6" style="border-color: var(--glass-border);">
                    <div class="flex gap-2 mb-4">
                        <button id="newFolderBtn" class="flex-1 secondary-btn text-sm font-semibold py-2 px-3 rounded-lg transition">New Folder</button>
                        <button id="selectModeBtn" class="flex-1 secondary-btn text-sm font-semibold py-2 px-3 rounded-lg transition">Select</button>
                    </div>
                    <div id="folder-list" class="space-y-2">
                    </div>
                </aside>

                <!-- Right Panel: Ideas -->
                <main class="w-full md:w-2/3 relative">
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="searchInput" class="flex-grow w-full border rounded-full py-1 px-3 focus:outline-none themed-input" placeholder="Search ideas...">
                    </div>
                    <div id="saved-ideas-list" class="space-y-4 h-[60vh] overflow-y-auto pr-2">
                    </div>
                    <!-- Bulk Action Bar -->
                    <div id="bulkActionBar" class="hidden absolute bottom-0 left-0 right-0 glass-card p-2 rounded-full flex items-center justify-between">
                        <span id="selectionCount" class="text-sm font-semibold px-4">0 items selected</span>
                        <div class="flex gap-2">
                            <button id="bulkMoveBtn" class="bg-indigo-500 font-semibold py-1 px-3 rounded-full">Move</button>
                            <button id="bulkDeleteBtn" class="bg-red-500 font-semibold py-1 px-3 rounded-full">Delete</button>
                        </div>
                    </div>
                </main>
             </div>
        </div>

        <!-- Themes View -->
        <div id="themesView" class="hidden w-full max-w-2xl mx-auto">
            <div class="glass-card rounded-2xl shadow-2xl p-6 md:p-8">
                <h2 class="text-3xl font-bold text-center mb-6">Your Themes</h2>
                <div id="theme-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Themes will be populated by JS -->
                </div>
            </div>
        </div>

        <!-- Store View (UPDATED)-->
        <div id="storeView" class="hidden w-full max-w-2xl mx-auto">
            <div class="glass-card rounded-2xl shadow-2xl p-6 md:p-8">
                 <h2 class="text-3xl font-bold text-center mb-2">Store & Premium</h2>
                 <p class="text-center mb-6" style="color:var(--text-secondary)">Enhance your experience.</p>
                 <div class="grid md:grid-cols-2 gap-6 mb-6">
                     <!-- Remove Ads Card -->
                     <div class="bg-white/10 p-6 rounded-lg text-center flex flex-col">
                         <h3 class="text-xl font-bold">Remove Ads</h3>
                         <p class="text-sm mt-1 flex-grow" style="color: var(--text-secondary);">Enjoy an ad-free experience forever.</p>
                         <p class="text-5xl font-bold my-4">$2.99</p>
                         <button id="removeAdsBtn" class="w-full bg-teal-500 text-black font-bold py-3 rounded-lg">Purchase</button>
                     </div>
                     <!-- Unlimited Generations Card -->
                     <div class="bg-white/10 p-6 rounded-lg text-center flex flex-col">
                         <h3 class="text-xl font-bold">Unlimited Generations</h3>
                         <p class="text-sm mt-1 flex-grow" style="color: var(--text-secondary);">Remove the daily idea generation limit forever.</p>
                         <p class="text-5xl font-bold my-4">$4.99</p>
                         <button id="unlimitedBtn" class="w-full bg-yellow-500 text-black font-bold py-3 rounded-lg">Go Premium</button>
                     </div>
                 </div>
                 <div class="grid grid-cols-1 gap-6">
                     <!-- Hacker Theme Card -->
                     <div class="bg-white/10 p-6 rounded-lg text-center">
                         <h3 class="text-xl font-bold font-mono text-green-400">Hacker Theme</h3>
                         <p class="text-sm mt-1" style="color: var(--text-secondary);">Unlock the classic green-on-black terminal theme.</p>
                         <p class="text-5xl font-bold my-4">$0.99</p>
                         <button id="buyHackerThemeBtn" class="w-full bg-green-500 text-black font-bold py-3 rounded-lg">Buy Theme</button>
                     </div>
                 </div>
            </div>
        </div>

    </div> <!-- End of main content wrapper -->

    <!-- Ad Banner -->
    <div id="adBanner">
        <!-- In a real app, this would be populated by an ad network like AdMob -->
        <span class="text-white">Ad Placeholder</span>
    </div>
    <!-- Modals -->
    <div id="chatModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="glass-card rounded-2xl p-4 md:p-6 max-w-lg w-full h-full max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Refine Idea</h2>
                <button id="closeChatModalBtn" class="text-3xl leading-none">&times;</button>
            </div>
            <div id="chat-history" class="flex-grow overflow-y-auto p-2 space-y-4 flex flex-col"></div>
            <div class="mt-4 flex items-center">
                <input type="text" id="chat-input" class="flex-grow themed-input border rounded-lg py-2 px-3 focus:outline-none" placeholder="e.g., 'make it shorter'">
                <button id="chat-send-btn" class="ml-2 bg-indigo-500 p-2 rounded-lg hover:bg-indigo-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </div>

     <div id="moveFolderModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="glass-card rounded-2xl p-6 max-w-sm w-full">
            <h3 class="font-bold text-lg mb-4">Move to Folder</h3>
            <select id="moveFolderSelect" class="w-full themed-input border rounded-lg p-2 mb-4"></select>
            <div class="flex justify-end gap-2">
                <button id="cancelMoveBtn" class="secondary-btn font-semibold py-1 px-4 rounded-full">Cancel</button>
                <button id="confirmMoveBtn" class="bg-indigo-500 font-semibold py-1 px-4 rounded-full">Move</button>
            </div>
        </div>
    </div>

    <div id="folderColorModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="glass-card rounded-2xl p-6 max-w-sm w-full">
            <h3 class="font-bold text-lg mb-4">Choose Folder Color</h3>
            <div id="color-options" class="grid grid-cols-5 gap-4"></div>
        </div>
    </div>
    
    <div id="newFolderModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="glass-card rounded-2xl p-6 max-w-sm w-full">
            <h3 class="font-bold text-lg mb-4">Create New Folder</h3>
            <input type="text" id="newFolderName" class="w-full themed-input border rounded-lg p-2 mb-4" placeholder="Folder name...">
            <div class="flex justify-end gap-2">
                <button id="cancelNewFolderBtn" class="secondary-btn font-semibold py-1 px-4 rounded-full">Cancel</button>
                <button id="confirmNewFolderBtn" class="bg-indigo-500 font-semibold py-1 px-4 rounded-full">Create</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal (NEW) -->
    <div id="customConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="glass-card rounded-2xl p-6 max-w-sm w-full text-center">
            <h3 id="confirmModalTitle" class="font-bold text-lg mb-4">Confirm Action</h3>
            <p id="confirmModalMessage" class="mb-6" style="color: var(--text-secondary);">Are you sure you want to proceed?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmModalCancelBtn" class="secondary-btn font-semibold py-2 px-6 rounded-full">Cancel</button>
                <button id="confirmModalConfirmBtn" class="bg-red-500 font-semibold py-2 px-6 rounded-full">Confirm</button>
            </div>
        </div>
    </div>
    <script>
        // --- DOM Elements ---
        const uiElements = {
            body: document.body, topicInput: document.getElementById('topic'), generateBtn: document.getElementById('generateBtn'),
            resultsDiv: document.getElementById('results'), loader: document.getElementById('loader'), errorMessage: document.getElementById('error-message'),
            savedIdeasList: document.getElementById('saved-ideas-list'),
            generatorView: document.getElementById('generatorView'), savedView: document.getElementById('savedView'), storeView: document.getElementById('storeView'), themesView: document.getElementById('themesView'),
            generatorTab: document.getElementById('generatorTab'), savedTab: document.getElementById('savedTab'), storeTab: document.getElementById('storeTab'), themesTab: document.getElementById('themesTab'),
            chatModal: document.getElementById('chatModal'), closeChatModalBtn: document.getElementById('closeChatModalBtn'),
            chatHistory: document.getElementById('chat-history'), chatInput: document.getElementById('chat-input'), chatSendBtn: document.getElementById('chat-send-btn'),
            newFolderBtn: document.getElementById('newFolderBtn'), searchInput: document.getElementById('searchInput'), 
            folderList: document.getElementById('folder-list'),
            themeList: document.getElementById('theme-list'),
            selectModeBtn: document.getElementById('selectModeBtn'), bulkActionBar: document.getElementById('bulkActionBar'),
            selectionCount: document.getElementById('selectionCount'), bulkMoveBtn: document.getElementById('bulkMoveBtn'), bulkDeleteBtn: document.getElementById('bulkDeleteBtn'),
            moveFolderModal: document.getElementById('moveFolderModal'), moveFolderSelect: document.getElementById('moveFolderSelect'),
            cancelMoveBtn: document.getElementById('cancelMoveBtn'), confirmMoveBtn: document.getElementById('confirmMoveBtn'),
            folderColorModal: document.getElementById('folderColorModal'), colorOptions: document.getElementById('color-options'),
            newFolderModal: document.getElementById('newFolderModal'), newFolderName: document.getElementById('newFolderName'),
            cancelNewFolderBtn: document.getElementById('cancelNewFolderBtn'), confirmNewFolderBtn: document.getElementById('confirmNewFolderBtn'),
            adBanner: document.getElementById('adBanner'), removeAdsBtn: document.getElementById('removeAdsBtn'),
            unlimitedBtn: document.getElementById('unlimitedBtn'), buyHackerThemeBtn: document.getElementById('buyHackerThemeBtn'),
            // New confirmation modal elements
            customConfirmModal: document.getElementById('customConfirmModal'),
            confirmModalTitle: document.getElementById('confirmModalTitle'),
            confirmModalMessage: document.getElementById('confirmModalMessage'),
            confirmModalCancelBtn: document.getElementById('confirmModalCancelBtn'),
            confirmModalConfirmBtn: document.getElementById('confirmModalConfirmBtn'),
        };

        // --- App State & Config ---
        let ideasData = { 
            folders: [], 
            uncategorized: [], 
            favoriteIDs: [], 
            ownedThemes: ['classic', 'light', 'dark'], 
            trash: [],
            adsRemoved: false,
            unlimitedGenerations: false
        };
        let activeFolder = 'all'; // 'all', 'favorites', 'trash', or folder index
        let generatedIdeas = [];
        let editing = { ideaId: null };
        let activeChat = { ideaId: null };
        let moving = { ideaId: null };
        let changingColorFolderIndex = null;
        let selectMode = false;
        let selectedItems = new Set();
        const FREE_GENERATIONS_LIMIT = 5;
        let generationCount = 0;
        const FOLDER_COLORS = {
            default: 'border-white/20', red: 'border-red-500', blue: 'border-blue-500',
            green: 'border-green-500', yellow: 'border-yellow-500', purple: 'border-purple-500',
            pink: 'border-pink-500',
        };

        // --- Event Listeners ---
        function addEventListeners() {
            window.addEventListener('load', () => {
                loadIdeasData();
                const savedTheme = localStorage.getItem('ideaSparkTheme') || 'classic';
                setTheme(savedTheme);
                updateUIForPurchases();
            });
            uiElements.generatorTab.addEventListener('click', () => switchView('generator'));
            uiElements.savedTab.addEventListener('click', () => switchView('saved'));
            uiElements.storeTab.addEventListener('click', () => switchView('store'));
            uiElements.themesTab.addEventListener('click', () => switchView('themes'));
            uiElements.generateBtn.addEventListener('click', handleGeneration);
            uiElements.newFolderBtn.addEventListener('click', () => uiElements.newFolderModal.classList.remove('hidden'));
            uiElements.cancelNewFolderBtn.addEventListener('click', () => uiElements.newFolderModal.classList.add('hidden'));
            uiElements.confirmNewFolderBtn.addEventListener('click', handleConfirmNewFolder);
            uiElements.searchInput.addEventListener('input', renderSavedIdeas);
            uiElements.chatSendBtn.addEventListener('click', handleChatSend);
            uiElements.chatInput.addEventListener('keypress', (e) => (e.key === 'Enter') && handleChatSend());
            uiElements.closeChatModalBtn.addEventListener('click', () => uiElements.chatModal.classList.add('hidden'));
            uiElements.cancelMoveBtn.addEventListener('click', () => {
                uiElements.moveFolderModal.classList.add('hidden');
                moving.ideaId = null;
            });
            uiElements.confirmMoveBtn.addEventListener('click', handleConfirmMove);
            uiElements.folderColorModal.addEventListener('click', (e) => (e.target === uiElements.folderColorModal) && uiElements.folderColorModal.classList.add('hidden'));
            uiElements.selectModeBtn.addEventListener('click', toggleSelectMode);
            uiElements.bulkMoveBtn.addEventListener('click', handleBulkMove);
            uiElements.bulkDeleteBtn.addEventListener('click', handleBulkDelete);
            // Store buttons
            uiElements.removeAdsBtn.addEventListener('click', purchaseRemoveAds);
            uiElements.unlimitedBtn.addEventListener('click', purchaseUnlimitedGenerations);
            uiElements.buyHackerThemeBtn.addEventListener('click', purchaseHackerTheme);

            // NEW: Confirmation Modal Buttons
            uiElements.confirmModalCancelBtn.addEventListener('click', () => uiElements.customConfirmModal.classList.add('hidden'));
            // Adding a new listener for the confirm button directly here
            uiElements.confirmModalConfirmBtn.addEventListener('click', () => {
                if (confirmActionCallback) {
                    confirmActionCallback();
                }
            });
        }
        // --- Core Functions: View Switching, Generation, API Fetching ---
        function switchView(viewName) {
            editing.ideaId = null;
            if (selectMode) toggleSelectMode(); // Always exit select mode when switching views
            const views = ['generator', 'saved', 'store', 'themes'];
            views.forEach(v => {
                uiElements[`${v}View`].classList.toggle('hidden', v !== viewName);
                uiElements[`${v}Tab`].classList.toggle('active', v === viewName);
            });
            if (viewName === 'saved') {
                activeFolder = 'all'; // Default to 'all' when switching to saved tab
                renderFolderList();
                renderSavedIdeas();
            } else if (viewName === 'themes') {
                renderThemeList();
            }
        }

        async function handleGeneration() {
             const topic = uiElements.topicInput.value.trim();
            if (!topic) { showError("Please enter a topic first!"); return; }
            if (!ideasData.unlimitedGenerations && generationCount >= FREE_GENERATIONS_LIMIT) {
                showError("You've reached your free generation limit. Go premium for unlimited ideas!"); return;
            }
            uiElements.loader.classList.remove('hidden');
            uiElements.resultsDiv.innerHTML = '';
            uiElements.errorMessage.classList.add('hidden');
            uiElements.generateBtn.disabled = true;
            try {
                const ideas = await fetchIdeasFromAI(`Generate a numbered list of 5 creative and unique ideas for the following topic: "${topic}". Return only the numbered list.`);
                generatedIdeas = ideas.map(idea => ({
                    id: `gen_${Date.now()}_${Math.random()}`,
                    originalIdea: idea.replace(/^\d+\.\s*/, ''),
                    conversation: []
                }));
                displayGeneratedIdeas();
                if (!ideasData.unlimitedGenerations) generationCount++;
            } catch (error) {
                console.error("A detailed error occurred:", error);
                showError("Sorry, we couldn't generate ideas right now.");
            } finally {
                uiElements.loader.classList.add('hidden');
                uiElements.generateBtn.disabled = false;
            }
        }

        async function fetchIdeasFromAI(prompt) {
            // Updated prompt to focus on refinement and conversation
            const apiKey = ""; // Keep this as empty string, Canvas will inject the key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            // Check if this is a refinement chat or initial idea generation
            let currentIdea = findIdeaById(activeChat.ideaId);
            let chatHistory = [];

            if (currentIdea && activeChat.ideaId) {
                // If it's a refinement chat, build history from the idea's conversation
                // The API expects roles 'user' and 'model'
                chatHistory.push({ role: "user", parts: [{ text: `Original idea: "${currentIdea.originalIdea}"` }] });
                currentIdea.conversation.forEach(msg => {
                    chatHistory.push({ role: msg.role === 'user' ? 'user' : 'model', parts: [{ text: msg.text }] });
                });
                chatHistory.push({ role: "user", parts: [{ text: prompt }] }); // Add the latest user prompt for refinement
            } else {
                // If it's initial idea generation, just use the provided prompt
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            }

            const payload = { contents: chatHistory };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("API Error Response:", errorData);
                throw new Error(`AI generation failed: ${errorData.error.message || response.statusText}`);
            }

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                // For initial generation, return as an array of ideas (split by numbered list)
                if (!activeChat.ideaId) { // This implies initial generation
                    return result.candidates[0].content.parts[0].text.split('\n').filter(line => line.trim().length > 0);
                } else { // This implies chat refinement, return as single string response
                    return [result.candidates[0].content.parts[0].text];
                }
            } else {
                throw new Error("Invalid response structure from AI.");
            }
        }

        // --- Data Persistence & Themes ---
        function loadIdeasData() {
            try {
                const data = localStorage.getItem('ideaSparkData_v7'); // Incremented version
                if (data) {
                    const parsedData = JSON.parse(data);
                    // Load all data, providing defaults for new properties
                    ideasData = {
                        folders: parsedData.folders?.map(f => ({ ...f, isCollapsed: f.isCollapsed ?? false, color: f.color ?? 'default' })) || [],
                        uncategorized: parsedData.uncategorized || [],
                        favoriteIDs: parsedData.favoriteIDs || [],
                        ownedThemes: parsedData.ownedThemes || ['classic', 'light', 'dark'],
                        trash: parsedData.trash || [],
                        adsRemoved: parsedData.adsRemoved || false,
                        unlimitedGenerations: parsedData.unlimitedGenerations || false
                    };
                }
            } catch (e) {
                console.error("Failed to load data, resetting.", e);
            }
        }

        function saveData() {
            localStorage.setItem('ideaSparkData_v7', JSON.stringify(ideasData)); // Incremented version
            updateUIForPurchases();
            if (!uiElements.savedView.classList.contains('hidden')) {
                renderFolderList();
                renderSavedIdeas();
            }
            if (!uiElements.generatorView.classList.contains('hidden')) {
                displayGeneratedIdeas();
            }
        }

        function setTheme(themeName) {
            if (!ideasData.ownedThemes.includes(themeName)) {
                showError(`Theme "${themeName}" is not owned. Visit the store.`);
                return;
            }
            uiElements.body.dataset.theme = themeName;
            localStorage.setItem('ideaSparkTheme', themeName);
        }
        
        // --- Purchase & UI Update Functions ---
        function purchaseRemoveAds() {
            console.log("Simulating 'Remove Ads' purchase...");
            ideasData.adsRemoved = true;
            saveData();
            showError("Ads have been removed! Thank you for your support.");
        }

        function purchaseUnlimitedGenerations() {
            console.log("Simulating 'Unlimited Generations' purchase...");
            ideasData.unlimitedGenerations = true;
            saveData();
            showError("You now have unlimited generations! Thank you.");
        }

        function purchaseHackerTheme() {
            console.log("Simulating 'Hacker Theme' purchase...");
            if (!ideasData.ownedThemes.includes('hacker')) {
                ideasData.ownedThemes.push('hacker');
            }
            saveData();
            renderThemeList(); // Re-render the theme list to show the new theme as owned
            showError("Hacker theme unlocked!");
        }

        function updateUIForPurchases() {
            // Handle Ad Banner visibility
            if (ideasData.adsRemoved) {
                uiElements.adBanner.style.display = 'none';
                document.body.style.paddingBottom = '0'; // Remove padding
            } else {
                uiElements.adBanner.style.display = 'flex';
                document.body.style.paddingBottom = '70px'; // Restore padding
            }

            // Update Store Buttons
            if (uiElements.removeAdsBtn) {
                uiElements.removeAdsBtn.disabled = ideasData.adsRemoved;
                uiElements.removeAdsBtn.textContent = ideasData.adsRemoved ? 'Purchased' : 'Purchase';
            }
            if (uiElements.unlimitedBtn) {
                uiElements.unlimitedBtn.disabled = ideasData.unlimitedGenerations;
                uiElements.unlimitedBtn.textContent = ideasData.unlimitedGenerations ? 'Purchased' : 'Go Premium';
            }
             if (uiElements.buyHackerThemeBtn) {
                const isOwned = ideasData.ownedThemes.includes('hacker');
                uiElements.buyHackerThemeBtn.disabled = isOwned;
                uiElements.buyHackerThemeBtn.textContent = isOwned ? 'Owned' : 'Buy Theme';
            }
        }
        // --- Select Mode & Bulk Actions ---
        function toggleSelectMode() {
            selectMode = !selectMode;
            uiElements.selectModeBtn.textContent = selectMode ? 'Cancel' : 'Select';
            uiElements.selectModeBtn.classList.toggle('active', selectMode);
            uiElements.bulkActionBar.classList.toggle('hidden', !selectMode);

            if (!selectMode) {
                selectedItems.clear();
            }
            updateSelectionCount();
            renderSavedIdeas();
        }

        function toggleIdeaSelection(ideaId, event) {
            event.stopPropagation();
            const checkbox = document.querySelector(`input[type="checkbox"][data-id="${ideaId}"]`);
            
            if (selectedItems.has(ideaId)) {
                selectedItems.delete(ideaId);
                if(checkbox) checkbox.checked = false;
            } else {
                selectedItems.add(ideaId);
                 if(checkbox) checkbox.checked = true;
            }
            updateSelectionCount();
            const card = document.querySelector(`div.glass-card[data-id='${ideaId}']`);
            if(card) {
                card.classList.toggle('ring-2', selectedItems.has(ideaId));
                card.classList.toggle('ring-indigo-400', selectedItems.has(ideaId));
            }
        }

        function updateSelectionCount() {
            const count = selectedItems.size;
            uiElements.selectionCount.textContent = `${count} item${count === 1 ? '' : 's'} selected`;
        }

        function handleBulkMove() {
            if (selectedItems.size === 0) {
                 showError("Select items to move first.");
                 return;
            }
            moving.ideaId = null; // Ensure single move isn't triggered
            uiElements.moveFolderSelect.innerHTML = ``; // Clear existing options

            // Only add user-defined folders to the move dropdown
            ideasData.folders.forEach((folder, index) => {
                const option = document.createElement('option');
                option.value = index;
                // Added a style attribute to the option to ensure text visibility on dark themes
                option.textContent = folder.name;
                option.style.color = 'var(--text-main)'; // Set text color from CSS variable
                option.style.backgroundColor = 'var(--input-bg)'; // Set background color from CSS variable
                uiElements.moveFolderSelect.appendChild(option);
            });
            uiElements.moveFolderModal.classList.remove('hidden');
        }

        function handleBulkDelete() {
            if (selectedItems.size === 0) {
                showError("Select items to delete first.");
                return;
            }
            // Using the custom confirm modal
            showConfirmModal(
                `Are you sure you want to move ${selectedItems.size} item${selectedItems.size === 1 ? '' : 's'} to the trash?`,
                () => { // Confirm action
                    selectedItems.forEach(id => {
                        const idea = findAndRemoveIdea(id);
                        if (idea) {
                            ideasData.trash.unshift(idea);
                        }
                    });
                    toggleSelectMode();
                    saveData();
                },
                () => { // Cancel action
                    // Do nothing or provide feedback
                }
            );
        }
        
        // --- Folder, Search, Filter & Idea Actions ---
        function handleConfirmNewFolder() {
            const folderName = uiElements.newFolderName.value.trim();
            if (folderName && !ideasData.folders.some(f => f.name === folderName)) {
                ideasData.folders.push({ name: folderName, ideas: [], isCollapsed: false, color: 'default' });
                saveData();
                uiElements.newFolderName.value = '';
                uiElements.newFolderModal.classList.add('hidden');
            } else if (folderName) {
                showError("A folder with that name already exists.");
            }
        }

        function deleteFolder(folderIndex) {
            const folder = ideasData.folders[folderIndex];
            if (!folder) return;

            // Using the custom confirm modal
            showConfirmModal(
                `Are you sure you want to delete the folder "${folder.name}"? All ideas within it will be moved to All Saved. This action cannot be undone for the folder itself.`, // More explicit message, now "All Saved"
                () => { // Confirm action
                    // Move ideas to uncategorized (which are displayed in "All Saved")
                    if (folder.ideas && folder.ideas.length > 0) {
                        ideasData.uncategorized.unshift(...folder.ideas);
                    }

                    // If the currently active folder is the one being deleted, switch to 'all'
                    if (activeFolder === folderIndex) {
                        activeFolder = 'all';
                    }

                    // Remove the folder
                    ideasData.folders.splice(folderIndex, 1);
                    
                    saveData();
                },
                () => { // Cancel action
                    // Do nothing or provide feedback
                },
                "Delete Folder Confirmation" // Custom title for folder deletion
            );
        }

        function openMoveModal(ideaId) {
            moving.ideaId = ideaId;
            selectedItems.clear(); // Ensure bulk selection isn't used for single move
            uiElements.moveFolderSelect.innerHTML = ``; // Clear existing options

            // Only add user-defined folders to the move dropdown
            ideasData.folders.forEach((folder, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = folder.name;
                // Added a style attribute to the option to ensure text visibility on dark themes
                option.style.color = 'var(--text-main)'; // Set text color from CSS variable
                option.style.backgroundColor = 'var(--input-bg)'; // Set background color from CSS variable
                uiElements.moveFolderSelect.appendChild(option);
            });
            uiElements.moveFolderModal.classList.remove('hidden');
        }

        function handleConfirmMove() {
            const targetFolderValue = uiElements.moveFolderSelect.value;
            const itemsToMove = [];

            if (selectedItems.size > 0) { // Bulk move
                selectedItems.forEach(id => {
                    const idea = findAndRemoveIdea(id);
                    if(idea) itemsToMove.push(idea);
                });
            } else if (moving.ideaId) { // Single move
                const idea = findAndRemoveIdea(moving.ideaId);
                if(idea) itemsToMove.push(idea);
            }

            if (itemsToMove.length > 0) {
                // Ideas can only be moved to explicit folders from the dropdown now.
                // If the target is not a valid folder index (e.g., if somehow a value other than an index slips through),
                // it should default to uncategorized to prevent data loss.
                if (typeof parseInt(targetFolderValue) === 'number' && ideasData.folders[parseInt(targetFolderValue)]) {
                     ideasData.folders[parseInt(targetFolderValue)].ideas.unshift(...itemsToMove);
                } else {
                    // Fallback: if somehow an invalid target, move to uncategorized (visible in All Saved)
                    ideasData.uncategorized.unshift(...itemsToMove);
                }
            }

            saveData();
            uiElements.moveFolderModal.classList.add('hidden');
            if(selectMode) toggleSelectMode(); // Exit select mode after bulk move
            moving.ideaId = null;
        }

        function openColorModal(folderIndex) {
            changingColorFolderIndex = folderIndex;
            uiElements.colorOptions.innerHTML = '';
            Object.keys(FOLDER_COLORS).forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.className = `w-12 h-12 rounded-full cursor-pointer border-4 ${FOLDER_COLORS[color]}`;
                colorDiv.onclick = () => setFolderColor(color);
                uiElements.colorOptions.appendChild(colorDiv);
            });
            uiElements.folderColorModal.classList.remove('hidden');
        }

        function setFolderColor(color) {
            if (changingColorFolderIndex !== null) {
                ideasData.folders[changingColorFolderIndex].color = color;
                saveData();
                uiElements.folderColorModal.classList.add('hidden');
                changingColorFolderIndex = null;
            }
        }
        function toggleFavorite(ideaId) {
            const favIndex = ideasData.favoriteIDs.indexOf(ideaId);
            if (favIndex > -1) {
                ideasData.favoriteIDs.splice(favIndex, 1);
            } else {
                // If an idea isn't saved yet (i.e., it's a generated idea), save it first.
                if (!findIdeaById(ideaId)) {
                     const ideaToSave = generatedIdeas.find(i => i.id === ideaId);
                     if (ideaToSave) saveGeneratedIdea(ideaToSave);
                }
                ideasData.favoriteIDs.unshift(ideaId);
            }
            saveData();
        }

        function saveGeneratedIdea(ideaObj) {
            if (!ideaObj) return;
            const isAlreadySaved = !!findIdeaById(ideaObj.id);
            if (!isAlreadySaved) {
                ideasData.uncategorized.unshift({ ...ideaObj });
                saveData();
            }
        }

        function unsaveIdea(ideaId) {
            const idea = findAndRemoveIdea(ideaId);
            if(idea) saveData();
        }

        function deleteIdea(ideaId) {
            const idea = findAndRemoveIdea(ideaId);
            if (idea) {
                ideasData.trash.unshift(idea);
                saveData();
            }
        }

        function restoreIdea(ideaId) {
            const trashIndex = ideasData.trash.findIndex(i => i.id === ideaId);
            if(trashIndex > -1) {
                const ideaToRestore = ideasData.trash.splice(trashIndex, 1)[0];
                ideasData.uncategorized.unshift(ideaToRestore);
                saveData();
            }
        }

        function permanentlyDeleteIdea(ideaId) {
            const trashIndex = ideasData.trash.findIndex(i => i.id === ideaId);
            if(trashIndex > -1) {
                ideasData.trash.splice(trashIndex, 1);
                saveData();
            }
        }

        function toggleEditMode(ideaId) {
            editing.ideaId = editing.ideaId === ideaId ? null : ideaId;
            renderSavedIdeas();
            displayGeneratedIdeas();
        }

        function handleEditSave(ideaId) {
            const ideaLocation = findIdeaLocation(ideaId);
            const textarea = document.querySelector(`div[data-id='${ideaId}'] textarea`);
            if (textarea && ideaLocation) {
                const newText = textarea.value;
                ideaLocation.array[ideaLocation.ideaIndex].originalIdea = newText;
                editing.ideaId = null;
                saveData();
            } else if (textarea) { 
                const genIdea = generatedIdeas.find(i => i.id === ideaId);
                if (genIdea) genIdea.originalIdea = textarea.value;
                editing.ideaId = null;
                displayGeneratedIdeas();
            }
        }

        function findIdeaById(id) {
            const allIdeas = [...ideasData.uncategorized, ...ideasData.folders.flatMap(f => f.ideas), ...ideasData.trash];
            return allIdeas.find(idea => idea.id === id) || null;
        }

        function findAndRemoveIdea(id) {
            const location = findIdeaLocation(id);
            if(location) {
                // Also remove from favorites if it exists there
                const favIndex = ideasData.favoriteIDs.indexOf(id);
                if (favIndex > -1) ideasData.favoriteIDs.splice(favIndex, 1);
                return location.array.splice(location.ideaIndex, 1)[0];
            }
            return null;
        }

        function findIdeaLocation(id) {
            for (let i = 0; i < ideasData.folders.length; i++) {
                const ideaIndex = ideasData.folders[i].ideas.findIndex(item => item.id === id);
                if (ideaIndex > -1) return { array: ideasData.folders[i].ideas, ideaIndex: ideaIndex, type: 'folder', folderIndex: i };
            }
            let uncatIndex = ideasData.uncategorized.findIndex(i => i.id === id);
            if (uncatIndex > -1) return { array: ideasData.uncategorized, ideaIndex: uncatIndex, type: 'uncategorized' };
            let trashIndex = ideasData.trash.findIndex(i => i.id === id);
            if(trashIndex > -1) return { array: ideasData.trash, ideaIndex: trashIndex, type: 'trash' };
            return null;
        }
        function createIdeaCard(ideaObj, type) {
            const ideaElement = document.createElement('div');
            ideaElement.className = 'glass-card p-4 rounded-lg flex items-center gap-4 transition-all';
            ideaElement.dataset.id = ideaObj.id;
            
            // Add selection elements if in select mode
            if (selectMode && (type === 'saved' || type === 'trash')) {
                 ideaElement.classList.add('cursor-pointer');
                 if (selectedItems.has(ideaObj.id)) {
                    ideaElement.classList.add('ring-2', 'ring-indigo-400');
                 }
                 ideaElement.onclick = (e) => toggleIdeaSelection(ideaObj.id, e);

                 const checkbox = document.createElement('input');
                 checkbox.type = 'checkbox';
                 checkbox.dataset.id = ideaObj.id;
                 checkbox.checked = selectedItems.has(ideaObj.id);
                 checkbox.className = 'form-checkbox h-5 w-5 rounded bg-white/20 border-white/30 text-indigo-500 focus:ring-indigo-500/50 shrink-0';
                 // Prevent card click from firing when the checkbox itself is clicked
                 checkbox.onclick = (e) => e.stopPropagation(); 
                 ideaElement.appendChild(checkbox);
            }

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'flex-grow flex flex-col gap-3';

            const mainContent = document.createElement('div');
            const isEditingThis = editing.ideaId === ideaObj.id;

            if (isEditingThis) {
                const textarea = document.createElement('textarea');
                textarea.value = ideaObj.originalIdea;
                textarea.className = 'w-full bg-white/20 border border-white/30 rounded-lg py-1 px-2 focus:outline-none themed-input';
                textarea.rows = '1';
                textarea.addEventListener('input', () => { textarea.style.height = 'auto'; textarea.style.height = (textarea.scrollHeight) + 'px'; });
                setTimeout(() => { textarea.style.height = 'auto'; textarea.style.height = (textarea.scrollHeight) + 'px'; }, 0);
                mainContent.appendChild(textarea);
            } else {
                mainContent.textContent = ideaObj.originalIdea;
            }
            contentWrapper.appendChild(mainContent);

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex items-center gap-2 justify-end border-t border-white/10 pt-3 flex-wrap';
            
            // Hide buttons when in select mode for saved/trash items
            if(selectMode && (type ==='saved' || type === 'trash')) {
                buttonContainer.classList.add('hidden');
            }

            if(isEditingThis) {
                 const saveBtn = document.createElement('button');
                 saveBtn.className = 'bg-green-500/80 text-white text-sm font-semibold py-1 px-3 rounded-full hover:bg-green-500/100 transition';
                 saveBtn.innerHTML = `Save`;
                 saveBtn.onclick = (e) => { e.stopPropagation(); handleEditSave(ideaObj.id); };
                 buttonContainer.appendChild(saveBtn);
                 const cancelBtn = document.createElement('button');
                 cancelBtn.className = 'bg-gray-500/80 text-white text-sm font-semibold py-1 px-3 rounded-full hover:bg-gray-500/100 transition';
                 cancelBtn.textContent = 'Cancel';
                 cancelBtn.onclick = (e) => { e.stopPropagation(); toggleEditMode(ideaObj.id); };
                 buttonContainer.appendChild(cancelBtn);
            } else if (type === 'trash') {
                const restoreBtn = document.createElement('button');
                restoreBtn.className = 'bg-green-500/80 text-white text-sm font-semibold py-1 px-3 rounded-full hover:bg-green-500/100 transition';
                restoreBtn.innerHTML = `Restore`;
                restoreBtn.onclick = (e) => { e.stopPropagation(); restoreIdea(ideaObj.id); };
                buttonContainer.appendChild(restoreBtn);

                const permDeleteBtn = document.createElement('button');
                permDeleteBtn.className = 'bg-red-500/80 text-white text-sm font-semibold py-1 px-3 rounded-full hover:bg-red-500/100 transition';
                permDeleteBtn.innerHTML = `Delete Forever`;
                permDeleteBtn.onclick = (e) => { e.stopPropagation(); permanentlyDeleteIdea(ideaObj.id); };
                buttonContainer.appendChild(permDeleteBtn);
            } else { // Standard buttons for saved and generated cards
                const isFavorite = ideasData.favoriteIDs.includes(ideaObj.id);
                const favButton = document.createElement('button');
                favButton.className = `p-2 rounded-full transition`;
                favButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
                favButton.style.color = isFavorite ? 'var(--favorite-color)' : 'var(--text-secondary)';
                favButton.firstElementChild.style.fill = isFavorite ? 'var(--favorite-color)' : 'none';
                favButton.onclick = (e) => { e.stopPropagation(); toggleFavorite(ideaObj.id); };
                buttonContainer.appendChild(favButton);

                if (type === 'generated') {
                     const isSaved = !!findIdeaById(ideaObj.id);
                     const saveButton = document.createElement('button');
                     saveButton.className = 'text-sm font-semibold py-1 px-3 rounded-full transition flex-shrink-0 secondary-btn';
                     saveButton.innerHTML = isSaved ? `Unsave` : `Save`;
                     if (isSaved) saveButton.classList.add('bg-red-500/80', 'hover:bg-red-500/100');
                     saveButton.onclick = (e) => { e.stopPropagation(); isSaved ? unsaveIdea(ideaObj.id) : saveGeneratedIdea(ideaObj); };
                     buttonContainer.appendChild(saveButton);
                } else {
                    const moveBtn = document.createElement('button');
                    moveBtn.className = 'secondary-btn text-sm font-semibold py-1 px-3 rounded-full transition';
                    moveBtn.innerHTML = `Move`;
                    moveBtn.onclick = (e) => { e.stopPropagation(); openMoveModal(ideaObj.id); };
                    buttonContainer.appendChild(moveBtn);
                }

                const chatButton = document.createElement('button');
                chatButton.className = 'secondary-btn text-sm font-semibold py-1 px-3 rounded-full transition';
                chatButton.innerHTML = `Chat`;
                chatButton.onclick = (e) => { e.stopPropagation(); openChat(ideaObj); };
                buttonContainer.appendChild(chatButton);

                const editButton = document.createElement('button');
                editButton.className = 'secondary-btn p-2 rounded-full transition';
                editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
                editButton.onclick = (e) => { e.stopPropagation(); toggleEditMode(ideaObj.id); };
                buttonContainer.appendChild(editButton);

                if (type !== 'generated') {
                     const deleteButton = document.createElement('button');
                     deleteButton.className = 'bg-red-500/50 text-white p-2 rounded-full hover:bg-red-500/80 transition';
                     deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 0 0 1 2 2v2"></path></svg>`;
                     deleteButton.onclick = (e) => { e.stopPropagation(); deleteIdea(ideaObj.id); };
                     buttonContainer.appendChild(deleteButton);
                }
            }
            contentWrapper.appendChild(buttonContainer);
            ideaElement.appendChild(contentWrapper);
            return ideaElement;
        }
        function displayGeneratedIdeas() {
            uiElements.resultsDiv.innerHTML = ''; 
            generatedIdeas.forEach((ideaObj) => {
                uiElements.resultsDiv.appendChild(createIdeaCard(ideaObj, 'generated'));
            });
        }

        function renderFolderList() {
            uiElements.folderList.innerHTML = '';
            const createFolderItem = (text, value, isDeletable = false, index = -1) => {
                const btn = document.createElement('button');
                let colorClass = 'border-transparent';
                if (typeof value === 'number') {
                    colorClass = FOLDER_COLORS[ideasData.folders[value].color] || FOLDER_COLORS.default;
                }
                btn.className = `folder-item w-full text-left p-2 rounded-lg font-semibold transition flex justify-between items-center border-l-4 ${activeFolder === value ? 'active' : 'hover:bg-white/10'} ${colorClass}`;
                
                const mainContent = document.createElement('div');
                mainContent.className = 'flex-grow flex justify-between items-center';
                
                const span = document.createElement('span');
                span.textContent = text;
                mainContent.appendChild(span);
                
                if(isDeletable) {
                    const buttonWrapper = document.createElement('div');
                    buttonWrapper.className = 'flex items-center';
                    if(activeFolder === index) {
                        const colorBtn = document.createElement('button');
                        colorBtn.className = 'p-1 rounded-full hover:bg-white/20';
                        colorBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z"></path></svg>`;
                        colorBtn.onclick = (e) => { e.stopPropagation(); openColorModal(index); };
                        buttonWrapper.appendChild(colorBtn);
                    }
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'p-1 rounded-full hover:bg-red-500/50';
                    deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                    deleteBtn.onclick = (e) => { e.stopPropagation(); deleteFolder(index); };
                    buttonWrapper.appendChild(deleteBtn);
                    mainContent.appendChild(buttonWrapper);
                }

                btn.appendChild(mainContent);
                btn.onclick = () => { if(!selectMode) { activeFolder = value; renderFolderList(); renderSavedIdeas(); } };
                return btn;
            };
            uiElements.folderList.appendChild(createFolderItem('All Saved', 'all'));
            uiElements.folderList.appendChild(createFolderItem('Favorites', 'favorites'));
            ideasData.folders.forEach((folder, index) => {
                uiElements.folderList.appendChild(createFolderItem(folder.name, index, true, index));
            });
            uiElements.folderList.appendChild(createFolderItem('Trash', 'trash'));
        }

        function renderSavedIdeas() {
            uiElements.savedIdeasList.innerHTML = '';
            const searchTerm = uiElements.searchInput.value.toLowerCase();
            let ideasToRender = [];

            if (activeFolder === 'all') {
                ideasToRender = [...ideasData.folders.flatMap(f => f.ideas), ...ideasData.uncategorized];
            } else if (activeFolder === 'favorites') {
                const allIdeas = [...ideasData.folders.flatMap(f => f.ideas), ...ideasData.uncategorized];
                ideasToRender = allIdeas.filter(idea => ideasData.favoriteIDs.includes(idea.id));
            } else if (activeFolder === 'trash') {
                ideasToRender = ideasData.trash;
            } else if (typeof activeFolder === 'number' && ideasData.folders[activeFolder]) {
                ideasToRender = ideasData.folders[activeFolder].ideas;
            }

            const filteredList = ideasToRender.filter(idea => idea.originalIdea.toLowerCase().includes(searchTerm));

            if (filteredList.length > 0) {
                 filteredList.forEach(ideaObj => {
                    const type = activeFolder === 'trash' ? 'trash' : 'saved';
                    uiElements.savedIdeasList.appendChild(createIdeaCard(ideaObj, type));
                 });
            } else {
                 uiElements.savedIdeasList.innerHTML = `<p class="text-center" style="color:var(--text-secondary)">No ideas here.</p>`;
            }
        }

        function renderThemeList() {
            uiElements.themeList.innerHTML = '';
            const themes = {
                classic: { name: 'Classic Spark', preview: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                light: { name: 'Light Mode', preview: 'linear-gradient(135deg, #f3f4f6 0%, #d1d5db 100%)' },
                dark: { name: 'Dark Mode', preview: 'linear-gradient(135deg, #1f2937 0%, #111827 100%)' },
                hacker: { name: 'Hacker', preview: 'linear-gradient(135deg, #000000 0%, #0D0D0D 100%)' }
            };

            Object.keys(themes).forEach(themeKey => {
                const theme = themes[themeKey];
                const card = document.createElement('div');
                const isOwned = ideasData.ownedThemes.includes(themeKey);
                card.className = `glass-card p-4 rounded-lg text-center flex flex-col items-center gap-2 ${isOwned ? 'cursor-pointer' : 'opacity-50'}`;
                if(isOwned) card.onclick = () => setTheme(themeKey);

                const preview = document.createElement('div');
                preview.className = 'w-16 h-16 rounded-full border-2 border-white/50';
                preview.style.background = theme.preview;

                const nameWrapper = document.createElement('div');
                nameWrapper.className = 'flex items-center gap-2 flex-wrap justify-center';
                const name = document.createElement('span');
                name.textContent = theme.name;
                name.className = 'font-semibold';
                nameWrapper.appendChild(name);

                if(!isOwned) {
                    const lock = document.createElement('span');
                    lock.textContent = 'ðŸ”’ Store';
                    lock.className = 'text-xs bg-yellow-500 text-black px-2 py-1 rounded-full whitespace-nowrap';
                    nameWrapper.appendChild(lock);
                }

                card.appendChild(preview);
                card.appendChild(nameWrapper);
                uiElements.themeList.appendChild(card);
            });
        }

        // --- Chat ---
        function openChat(ideaObj) {
            saveGeneratedIdea(ideaObj);
            activeChat.ideaId = ideaObj.id;
            renderChatHistory();
            uiElements.chatModal.classList.remove('hidden');
        }

        function renderChatHistory() {
            uiElements.chatHistory.innerHTML = '';
            const idea = findIdeaById(activeChat.ideaId);
            if (!idea) return;

            const originalIdeaBubble = document.createElement('div');
            originalIdeaBubble.className = 'chat-bubble chat-bubble-ai';
            originalIdeaBubble.innerHTML = `<p class="font-bold mb-1">Original Idea</p><p>${idea.originalIdea}</p>`;
            uiElements.chatHistory.appendChild(originalIdeaBubble);
            idea.conversation.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
                bubble.textContent = msg.text;
                uiElements.chatHistory.appendChild(bubble);
            });
            uiElements.chatHistory.scrollTop = uiElements.chatHistory.scrollHeight;
        }

        async function handleChatSend() {
            const userInput = uiElements.chatInput.value.trim();
            const idea = findIdeaById(activeChat.ideaId);
            if (!userInput || !idea) return;

            // Add user message to conversation
            idea.conversation.push({ role: 'user', text: userInput });
            renderChatHistory();
            uiElements.chatInput.value = '';

            // Construct the prompt for AI to continue the conversation about the specific idea
            let conversationPrompt = `Given the original idea: "${idea.originalIdea}".\n`;
            conversationPrompt += `Previous conversation history:\n`;
            idea.conversation.slice(0, -1).forEach(msg => { // Exclude the very last user message to avoid duplication in context
                conversationPrompt += `${msg.role === 'user' ? 'User' : 'AI'}: ${msg.text}\n`;
            });
            conversationPrompt += `User: ${userInput}\n`; // Add the latest user message
            conversationPrompt += `\nBased on the original idea and the conversation history, please respond to the user's last message. Focus on discussing, refining, or elaborating on the *original idea*. Do not generate new, unrelated ideas. Provide a direct, conversational response.`;

            try {
                const response = await fetchIdeasFromAI(conversationPrompt); // Pass the detailed prompt
                const aiResponse = response[0]; // fetchIdeasFromAI now returns a single string for chat
                idea.conversation.push({ role: 'ai', text: aiResponse });
                saveData();
                renderChatHistory();
            } catch (error) {
                console.error("Chat generation error:", error);
                 showError("Could not get chat response.");
            }
        }

        function showError(message) {
            uiElements.errorMessage.textContent = message;
            uiElements.errorMessage.classList.remove('hidden');
            setTimeout(() => {
                uiElements.errorMessage.classList.add('hidden');
            }, 3000);
        }

        // Generic function to show custom confirmation modal
        let confirmActionCallback = null;
        let cancelActionCallback = null;

        function showConfirmModal(message, onConfirm, onCancel, title = "Confirm Action") {
            uiElements.confirmModalTitle.textContent = title;
            uiElements.confirmModalMessage.textContent = message;
            uiElements.customConfirmModal.classList.remove('hidden');
            
            // Clear previous event listeners to prevent unintended multiple calls
            uiElements.confirmModalConfirmBtn.removeEventListener('click', confirmActionCallback);
            uiElements.confirmModalCancelBtn.removeEventListener('click', cancelActionCallback);

            confirmActionCallback = () => {
                uiElements.customConfirmModal.classList.add('hidden');
                onConfirm();
            };
            cancelActionCallback = () => {
                uiElements.customConfirmModal.classList.add('hidden');
                if (onCancel) onCancel();
            };

            // Add new listeners
            uiElements.confirmModalConfirmBtn.addEventListener('click', confirmActionCallback);
            uiElements.confirmModalCancelBtn.addEventListener('click', cancelActionCallback);
        }

        addEventListeners();
    </script>
</body>
</html>
